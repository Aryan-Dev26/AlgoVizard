<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Sort Visualizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/college-theme.css') }}">
    <style>
        .visualizer-page {
            padding: 120px 20px 40px;
            min-height: 100vh;
        }

        .visualizer-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .visualizer-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .visualizer-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .visualizer-header p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.1rem;
        }

        .controls-panel {
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .array-controls {
            margin-top: 20px;
        }

        .array-controls input {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            width: 300px;
            margin-right: 10px;
        }

        .array-controls input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .speed-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: rgba(255, 255, 255, 0.95);
        }

        .speed-slider {
            width: 200px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            appearance: none;
        }

        .visualization-area {
            padding: 40px;
            margin-bottom: 30px;
            min-height: 350px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 8px;
        }

        .array-bar.swapped {
            animation: swapPulse 0.5s ease;
        }

        @keyframes swapPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .step-info {
            padding: 25px;
            text-align: center;
        }

        .algorithm-info {
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
        }

        .algorithm-complexity {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .sound-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        @media (max-width: 768px) {
            .visualizer-page {
                padding: 80px 20px 40px;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 200px;
            }
            
            .algorithm-complexity {
                flex-direction: column;
                gap: 15px;
            }

            .array-controls input {
                width: 250px;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="sound-controls">
        <button class="btn btn-secondary" onclick="toggleSound()" id="soundToggle">üîä</button>
    </div>

    <div class="visualizer-page">
        <div class="visualizer-container">
            <div class="visualizer-header">
                <a href="/algorithms" class="back-button glass">‚Üê Back to Algorithms</a>
                <h1>Bubble Sort Visualizer</h1>
                <p>Watch how bubble sort compares and swaps adjacent elements to sort the array</p>
            </div>

            <div class="algorithm-info glass">
                <h3>How Bubble Sort Works</h3>
                <p>Bubble sort repeatedly steps through the list, compares adjacent elements and swaps them if they're in the wrong order. The largest elements "bubble" to the end like air bubbles rising to the surface.</p>
                <div class="algorithm-complexity">
                    <div class="complexity-item">Time: <span class="complexity-value">O(n¬≤)</span></div>
                    <div class="complexity-item">Space: <span class="complexity-value">O(1)</span></div>
                    <div class="complexity-item">Stability: <span class="complexity-value">Yes</span></div>
                </div>
            </div>

            <div class="controls-panel glass">
                <div class="control-buttons">
                    <button class="btn btn-primary" id="startBtn" onclick="startVisualization()">Start Sorting</button>
                    <button class="btn btn-warning" id="stopBtn" onclick="stopVisualization()" disabled>Stop</button>
                    <button class="btn btn-secondary" onclick="resetVisualization()">Reset</button>
                    <a href="/algorithms" class="btn btn-secondary">Back to Algorithms</a>
                </div>
                
                <div class="speed-control">
                    <span>Speed:</span>
                    <input type="range" id="speedSlider" class="speed-slider" min="100" max="2000" value="800" step="100">
                    <span id="speedValue">800ms</span>
                </div>

                <div class="array-controls">
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="generateRandomArray()">Random Array</button>
                        <button class="btn btn-secondary" onclick="toggleCustomInput()">Custom Input</button>
                    </div>
                    
                    <div id="customInputSection" style="display: none;">
                        <input type="text" id="customArrayInput" placeholder="Enter numbers: 5,3,8,1,9">
                        <button class="btn btn-primary" onclick="setCustomArray()">Set Array</button>
                    </div>
                </div>
            </div>

            <div class="visualization-area glass" id="arrayContainer">
                <!-- Array bars will be generated here -->
            </div>

            <div class="step-info glass">
                <div class="step-description" id="stepDescription">Click "Start Sorting" to begin visualization</div>
                <div class="step-counter" id="stepCounter">Step: 0</div>
            </div>
        </div>
    </div>

    <!-- Floating programming symbols -->
    <div class="floating-symbols">
        <div class="code-symbol symbol-1">{}</div>
        <div class="code-symbol symbol-2">&lt;/&gt;</div>
        <div class="code-symbol symbol-3">[ ]</div>
        <div class="code-symbol symbol-4">( )</div>
        <div class="code-symbol symbol-5">;</div>
        <div class="code-symbol symbol-6">=&gt;</div>
    </div>

    <script>
        let algorithmSteps = [];
        let currentStep = 0;
        let isRunning = false;
        let shouldStop = false;
        let currentArray = [64, 34, 25, 12, 22, 11, 90];

        // Sound effects
        let audioContext;
        let isAudioEnabled = true;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(frequency, duration) {
            if (!isAudioEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playCompareSound() {
            playSound(800, 0.1);
        }

        function playSwapSound() {
            playSound(400, 0.2);
        }

        function playCompleteSound() {
            setTimeout(() => playSound(523, 0.2), 0);
            setTimeout(() => playSound(659, 0.2), 200);
            setTimeout(() => playSound(784, 0.4), 400);
        }

        function toggleSound() {
            initAudio();
            isAudioEnabled = !isAudioEnabled;
            document.getElementById('soundToggle').textContent = isAudioEnabled ? 'üîä' : 'üîá';
        }

        // Array management functions
        function generateRandomArray() {
            currentArray = [];
            for (let i = 0; i < 7; i++) {
                currentArray.push(Math.floor(Math.random() * 90) + 10);
            }
            displayArray(currentArray);
            document.getElementById('stepDescription').textContent = 'Random array generated! Click "Start Sorting" to begin.';
        }

        function toggleCustomInput() {
            const section = document.getElementById('customInputSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function setCustomArray() {
            const input = document.getElementById('customArrayInput').value;
            const numbers = input.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            
            if (numbers.length > 0 && numbers.length <= 10) {
                currentArray = numbers;
                displayArray(currentArray);
                document.getElementById('stepDescription').textContent = 'Custom array set! Click "Start Sorting" to begin.';
                toggleCustomInput();
                document.getElementById('customArrayInput').value = '';
            } else {
                alert('Please enter 1-10 valid numbers separated by commas');
            }
        }

        function displayArray(arrayData, comparing = [], swapped = false) {
            const container = document.getElementById('arrayContainer');
            container.innerHTML = '';

            arrayData.forEach((value, index) => {
                const bar = document.createElement('div');
                bar.className = 'array-bar';
                bar.style.height = `${Math.max(value * 2.5, 30)}px`;
                bar.textContent = value;
                
                if (comparing.includes(index)) {
                    bar.classList.add('comparing');
                }
                
                if (swapped && comparing.includes(index)) {
                    bar.classList.add('swapped');
                }
                
                container.appendChild(bar);
            });
        }

        async function startVisualization() {
            if (isRunning) return;
            
            isRunning = true;
            shouldStop = false;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            document.getElementById('stepDescription').textContent = 'Loading algorithm steps...';
            
            try {
                const response = await fetch('/api/bubble-sort', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ array: currentArray })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                algorithmSteps = await response.json();
                
                for (let i = 0; i < algorithmSteps.length && !shouldStop; i++) {
                    const step = algorithmSteps[i];
                    
                    displayArray(step.array, step.comparing, step.swapped);
                    document.getElementById('stepDescription').textContent = step.description;
                    document.getElementById('stepCounter').textContent = `Step: ${step.step} of ${algorithmSteps.length - 1}`;
                    
                    // Play sounds
                    if (step.comparing && step.comparing.length > 0) {
                        playCompareSound();
                    }
                    
                    if (step.swapped) {
                        playSwapSound();
                    }
                    
                    currentStep = i;
                    await sleep(getSpeed());
                }
                
                if (!shouldStop) {
                    playCompleteSound();
                    document.getElementById('stepDescription').textContent = 'Sorting complete! All elements are now in their correct positions.';
                }
                
            } catch (error) {
                console.error('Error:', error);
                // Fallback to original API if POST fails
                try {
                    const response = await fetch('/api/bubble-sort');
                    algorithmSteps = await response.json();
                    // Continue with original logic...
                } catch (fallbackError) {
                    document.getElementById('stepDescription').textContent = `Error loading algorithm: ${error.message}`;
                }
            }
            
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function stopVisualization() {
            shouldStop = true;
            isRunning = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('stepDescription').textContent = 'Visualization stopped';
        }

        function resetVisualization() {
            if (isRunning) {
                stopVisualization();
            }
            
            displayArray(currentArray);
            document.getElementById('stepDescription').textContent = 'Click "Start Sorting" to begin visualization';
            document.getElementById('stepCounter').textContent = 'Step: 0';
            currentStep = 0;
        }

        function getSpeed() {
            const slider = document.getElementById('speedSlider');
            return parseInt(slider.value);
        }

        function updateSpeedDisplay() {
            const slider = document.getElementById('speedSlider');
            const speedValue = document.getElementById('speedValue');
            speedValue.textContent = slider.value + 'ms';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initialize
        resetVisualization();
        updateSpeedDisplay();
        initAudio();

        document.getElementById('speedSlider').addEventListener('input', updateSpeedDisplay);
    </script>
</body>
</html>