<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <title>Analytics Dashboard - AlgoVizard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared.css') }}">
    {% if theme == 'school' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/school-theme.css') }}">
    {% else %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/college-theme.css') }}">
    {% endif %}
    <style>
        .dashboard-page {
            padding: 40px 20px;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 15px;
        }

        .dashboard-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            padding: 25px;
            text-align: center;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            padding: 25px;
            border-radius: 15px;
        }

        .chart-title {
            color: white;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .algorithm-usage {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .usage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .usage-bar {
            width: 60%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .usage-fill {
            height: 100%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
        }

        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .activity-details {
            flex: 1;
        }

        .activity-action {
            color: white;
            font-weight: 500;
        }

        .activity-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }

        .learner-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .learner-card {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .learner-percentage {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .learner-name {
            color: white;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .learner-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body data-theme="{{ theme }}">
    <div class="dashboard-page">
        <div class="dashboard-container">
            <!-- Navigation -->
            <div style="margin-bottom: 30px; text-align: center;">
                <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
                <a href="/algorithms" class="btn btn-secondary" style="margin-left: 15px;">All Algorithms</a>
            </div>

            <!-- Header -->
            <div class="dashboard-header">
                <h1>Analytics Dashboard</h1>
                <p>Comprehensive insights into platform usage and learning patterns</p>
            </div>

            <!-- Stats Overview -->
            <div class="stats-overview">
                <div class="stat-card glass">
                    <span class="stat-icon">üë•</span>
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card glass">
                    <span class="stat-icon">üéØ</span>
                    <div class="stat-number" id="totalInteractions">0</div>
                    <div class="stat-label">Total Interactions</div>
                </div>
                <div class="stat-card glass">
                    <span class="stat-icon">üìä</span>
                    <div class="stat-number" id="totalVisualizations">0</div>
                    <div class="stat-label">Visualizations Run</div>
                </div>
                <div class="stat-card glass">
                    <span class="stat-icon">üß†</span>
                    <div class="stat-number" id="quizzesTaken">0</div>
                    <div class="stat-label">Quizzes Completed</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Algorithm Usage -->
                <div class="chart-card glass">
                    <h3 class="chart-title">Algorithm Usage</h3>
                    <div class="algorithm-usage" id="algorithmUsage">
                        <!-- Usage bars will be generated here -->
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="chart-card glass">
                    <h3 class="chart-title">Recent Activity</h3>
                    <div class="recent-activity" id="recentActivity">
                        <!-- Activity items will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Learner Types Analysis -->
            <div class="chart-card glass">
                <h3 class="chart-title">Learner Type Distribution</h3>
                <div class="learner-types" id="learnerTypes">
                    <div class="learner-card">
                        <div class="learner-percentage" id="visualExplorerPct">0%</div>
                        <div class="learner-name">Visual Explorer</div>
                        <div class="learner-description">Prefers visual engagement</div>
                    </div>
                    <div class="learner-card">
                        <div class="learner-percentage" id="methodicalLearnerPct">0%</div>
                        <div class="learner-name">Methodical Learner</div>
                        <div class="learner-description">Systematic approach</div>
                    </div>
                    <div class="learner-card">
                        <div class="learner-percentage" id="quickExperimenterPct">0%</div>
                        <div class="learner-name">Quick Experimenter</div>
                        <div class="learner-description">Fast-paced learning</div>
                    </div>
                    <div class="learner-card">
                        <div class="learner-percentage" id="strugglingLearnerPct">0%</div>
                        <div class="learner-name">Struggling Learner</div>
                        <div class="learner-description">Needs additional support</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating programming symbols -->
    <div class="floating-symbols">
        <div class="code-symbol symbol-1">{}</div>
        <div class="code-symbol symbol-2">&lt;/&gt;</div>
        <div class="code-symbol symbol-3">[ ]</div>
        <div class="code-symbol symbol-4">( )</div>
        <div class="code-symbol symbol-5">;</div>
        <div class="code-symbol symbol-6">=&gt;</div>
    </div>

    <script>
        class AnalyticsDashboard {
            constructor() {
                this.loadAnalytics();
                this.refreshInterval = setInterval(() => this.loadAnalytics(), 30000); // Refresh every 30 seconds
            }

            async loadAnalytics() {
                try {
                    const response = await fetch('/api/analytics');
                    const data = await response.json();
                    
                    this.updateOverviewStats(data);
                    this.updateAlgorithmUsage(data);
                    this.updateRecentActivity(data);
                    
                } catch (error) {
                    console.error('Error loading analytics:', error);
                }
            }

            updateOverviewStats(data) {
                document.getElementById('totalUsers').textContent = this.getUniqueUsers(data);
                document.getElementById('totalInteractions').textContent = data.total_interactions || 0;
                document.getElementById('totalVisualizations').textContent = this.getVisualizationCount(data);
                document.getElementById('quizzesTaken').textContent = this.getQuizCount(data);
            }

            updateAlgorithmUsage(data) {
                const container = document.getElementById('algorithmUsage');
                container.innerHTML = '';

                const algorithms = data.algorithms_accessed || {};
                const total = Object.values(algorithms).reduce((sum, count) => sum + count, 0);

                const algorithmNames = {
                    'bubble_sort': 'Bubble Sort',
                    'selection_sort': 'Selection Sort',
                    'insertion_sort': 'Insertion Sort',
                    'merge_sort': 'Merge Sort',
                    'algorithm_comparison': 'Algorithm Comparison',
                    'quiz_mode': 'Quiz Mode'
                };

                Object.entries(algorithms).forEach(([algorithm, count]) => {
                    const percentage = total > 0 ? (count / total) * 100 : 0;
                    const displayName = algorithmNames[algorithm] || algorithm;

                    const item = document.createElement('div');
                    item.className = 'usage-item';
                    item.innerHTML = `
                        <span style="color: white; font-weight: 500;">${displayName}</span>
                        <div class="usage-bar">
                            <div class="usage-fill" style="width: ${percentage}%"></div>
                        </div>
                        <span style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">${count}</span>
                    `;
                    container.appendChild(item);
                });
            }

            updateRecentActivity(data) {
                const container = document.getElementById('recentActivity');
                container.innerHTML = '';

                const activities = data.recent_activity || [];
                
                if (activities.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">No recent activity</div>';
                    return;
                }

                activities.slice(0, 10).forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    
                    const icon = this.getActivityIcon(activity.action);
                    const description = this.getActivityDescription(activity);
                    const timeAgo = this.getTimeAgo(activity.timestamp);

                    item.innerHTML = `
                        <div class="activity-icon">${icon}</div>
                        <div class="activity-details">
                            <div class="activity-action">${description}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            getActivityIcon(action) {
                const icons = {
                    'page_view': 'üëÅÔ∏è',
                    'api_request': 'üîÑ',
                    'visualization_started': '‚ñ∂Ô∏è',
                    'visualization_completed': '‚úÖ',
                    'quiz_completed': 'üß†',
                    'comparison_completed': '‚öñÔ∏è',
                    'theme_changed': 'üé®',
                    'custom_array_used': 'üìù'
                };
                return icons[action] || 'üìä';
            }

            getActivityDescription(activity) {
                const descriptions = {
                    'page_view': `Viewed ${activity.algorithm} page`,
                    'api_request': `Requested ${activity.algorithm} data`,
                    'visualization_started': `Started ${activity.algorithm} visualization`,
                    'visualization_completed': `Completed ${activity.algorithm} visualization`,
                    'quiz_completed': 'Completed algorithm quiz',
                    'comparison_completed': 'Completed algorithm comparison',
                    'theme_changed': `Changed theme to ${activity.data?.theme || 'unknown'}`,
                    'custom_array_used': `Used custom array (${activity.data?.array_size || 0} elements)`
                };
                return descriptions[activity.action] || activity.action;
            }

            getTimeAgo(timestamp) {
                const now = new Date();
                const time = new Date(timestamp);
                const diffMs = now - time;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return `${diffDays}d ago`;
            }

            getUniqueUsers(data) {
                // Count unique IP addresses from recent activity
                const activities = data.recent_activity || [];
                const uniqueIPs = new Set(activities.map(a => a.ip_address).filter(ip => ip));
                return uniqueIPs.size;
            }

            getVisualizationCount(data) {
                const activities = data.recent_activity || [];
                return activities.filter(a => a.action === 'visualization_completed').length;
            }

            getQuizCount(data) {
                const activities = data.recent_activity || [];
                return activities.filter(a => a.action === 'quiz_completed').length;
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AnalyticsDashboard();
        });
    </script>
</body>
</html>
